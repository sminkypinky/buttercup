<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buttercup - Your Personal Playlist Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes sway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-sway {
            animation: sway 2s ease-in-out infinite;
            transform-origin: bottom center;
        }
        .animate-bounce-slow {
            animation: bounce 2s ease-in-out infinite;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
        .logo-container {
            width: 100px;
            height: 100px;
            margin: 0 auto 1rem;
        }
        .logo-container svg {
            width: 100%;
            height: 100%;
        }
    </style>
    <style>
        #submit-btn:disabled {
            position: relative;
            overflow: hidden;
        }
        #submit-btn:disabled::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent
            );
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            100% {
                left: 100%;
            }
        }
    </style>
    <style>
        .spotify-button {
            background-color: #1DB954;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            display: inline-block;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .spotify-button:hover {
            background-color: #1ed760;
        }
    </style>
    <style>
        @media (max-width: 640px) {
            .btn {
                width: 100%;
            }
        }
        .form-container {
            background-color: #f0f7ff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #4a5568;
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%234a5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #4c51bf;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-2xl">
        <div class="logo-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <g transform="translate(50 50)">
                    <path d="M0,-30 C-20,-30 -30,-20 -30,0 C-30,20 -20,30 0,30 C20,30 30,20 30,0 C30,-20 20,-30 0,-30 Z" fill="#FFD700" />
                    <circle cx="0" cy="0" r="10" fill="#8B4513" />
                    <path d="M-3,-25 L0,-40 L3,-25 Z" fill="#008000" />
                </g>
            </svg>
        </div>
        <h1 class="text-3xl font-bold mb-4 text-center text-indigo-600">Buttercup</h1>
        <p class="text-lg text-center mb-6">Your Personal Playlist Generator</p>
        
        <div class="mb-8 text-gray-700">
            <p class="mb-4">Welcome to Buttercup, your nostalgic journey through music! Here's how it works:</p>
            <ol class="list-decimal pl-6 space-y-2">
                <li>Enter your birth month, year, and country of origin.</li>
                <li>Buttercup will craft a personalized playlist that reflects your life's musical journey.</li>
                <li>Discover songs from significant years in your life
                <li>Explore tunes tied to global events, your school years, and more!</li>
            </ol>
            <p class="mt-4">Get ready to relive your memories through the power of music. Let's create your unique soundtrack!</p>
        </div>

        <div class="form-container">
            <form id="playlist-form" class="space-y-4">
                <div class="flex flex-col sm:flex-row sm:space-x-4">
                    <div class="form-group w-full sm:w-1/2">
                        <label for="birth-month" class="form-label">Birth Month:</label>
                        <select id="birth-month" name="birth-month" required class="form-select">
                            <option value="">Select Month</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group w-full sm:w-1/2">
                        <label for="birth-year" class="form-label">Birth Year:</label>
                        <input type="number" id="birth-year" name="birth-year" min="1900" max="2024" required class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label for="country" class="form-label">Country:</label>
                    <select id="country" name="country" required class="form-select">
                        <option value="United Kingdom">United Kingdom</option>
                    </select>
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400 disabled:hover:bg-gray-400 disabled:shadow-none">
                    Generate My Playlist
                </button>
            </form>
        </div>
        <div id="loading" class="mt-8 text-center hidden">
            <div class="inline-block animate-bounce-slow">
                <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" class="animate-sway">
                    <g transform="translate(50 50)">
                        <path d="M0,-30 C-20,-30 -30,-20 -30,0 C-30,20 -20,30 0,30 C20,30 30,20 30,0 C30,-20 20,-30 0,-30 Z" fill="#FFD700" />
                        <circle cx="0" cy="0" r="10" fill="#8B4513" />
                        <path d="M-3,-25 L0,-40 L3,-25 Z" fill="#008000" />
                    </g>
                </svg>
            </div>
            <p id="loading-message" class="mt-4 text-lg font-semibold">Crafting your musical journey... Please wait.</p>
            <button id="cancel-generation" class="mt-4 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                Cancel Generation
            </button>
        </div>
        <div id="result" class="mt-8 hidden">
            <h2 class="text-xl font-semibold mb-2">Your Personalized Playlist:</h2>
            <ul id="playlist" class="list-disc pl-5 space-y-2"></ul>
            <div class="mt-4 flex flex-col space-y-2 sm:flex-row sm:space-y-0 sm:space-x-2">
                <button id="create-spotify-playlist" class="btn bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 hidden">
                    Create Playlist on Spotify
                </button>
                <button id="regenerate-playlist" class="btn bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
                    Re-generate Playlist
                </button>
                <button id="start-over" class="btn bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Start Again
                </button>
            </div>
        </div>
        <div id="error" class="mt-4 text-red-600 hidden"></div>
    </div>

    <!-- Modal -->
    <div class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Spotify Playlist Creation</p>
                    <div class="modal-close cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>
                <div id="modal-content"></div>
                <div class="flex justify-end pt-2">
                    <button class="modal-close px-4 bg-indigo-500 p-3 rounded-lg text-white hover:bg-indigo-400">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let generatedPlaylist = null;

        let isGenerating = false;
        let controller = null;

        document.getElementById('playlist-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isGenerating) {
                saveFormData();
                const birthMonth = document.getElementById('birth-month').value;
                const birthYear = document.getElementById('birth-year').value;
                const country = document.getElementById('country').value;
                await generatePlaylist(birthMonth, birthYear, country);
            }
        });

        document.getElementById('create-spotify-playlist').addEventListener('click', async () => {
            if (!generatedPlaylist) {
                alert('Please generate a playlist first.');
                return;
            }

            const clientId = '0568b723e6134b0fa22bab9c9e126e00';
            const redirectUri = 'https://buttercup-bfa5ac5c72f8.herokuapp.com/callback';
            const scope = 'playlist-modify-private';

            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}&show_dialog=true`;

            const authWindow = window.open(authUrl, 'Spotify Authorization', 'width=800,height=600');

            showModal('Authorizing with Spotify...');

            window.addEventListener('message', async (event) => {
                if (event.origin !== window.location.origin) return;

                if (event.data.type === 'SPOTIFY_AUTH_SUCCESS') {
                    authWindow.close();
                    const code = event.data.code;

                    updateModal('Creating playlist on Spotify...');

                    try {
                        const response = await fetch('/create_spotify_playlist', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                code: code,
                                playlist: generatedPlaylist
                            }),
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            updateModal(`
                                <p class="mb-4">${data.message}</p>
                                <p class="mb-4">Your playlist is ready! Click the button below to open it in Spotify:</p>
                                <a href="${data.playlistUrl}" target="_blank" class="spotify-button">Open in Spotify</a>
                            `);
                        } else {
                            throw new Error(data.error || 'Failed to create Spotify playlist');
                        }
                    } catch (error) {
                        console.error('Error creating Spotify playlist:', error);
                        updateModal(`Error creating Spotify playlist: ${error.message}`);
                    }
                }
            }, false);
        });

        // Modal functions
        function showModal(content) {
            document.querySelector('.modal').classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            document.getElementById('modal-content').innerHTML = content;
        }

        function updateModal(content) {
            document.getElementById('modal-content').innerHTML = content;
        }

        function closeModal() {
            document.querySelector('.modal').classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }

        // Close modal when clicking outside or on close button
        document.querySelectorAll('.modal-overlay, .modal-close').forEach(elem => {
            elem.addEventListener('click', closeModal);
        });

        const loadingMessages = [
        "Tuning the time machine...",
        "Dusting off vinyl records...",
        "Untangling cassette tapes...",
        "Polishing golden oldies...",
        "Syncing with the rhythm of your life...",
        "Decoding the musical DNA of your era...",
        "Harmonizing your memories...",
        "Composing your life's soundtrack...",
        "Remixing the hits of your youth...",
        "Orchestrating a symphony of nostalgia..."
        ];

        let messageIndex = 0;
        let messageInterval;

        function rotateLoadingMessage() {
            const loadingMessageElement = document.getElementById('loading-message');
            messageIndex = (messageIndex + 1) % loadingMessages.length;
            loadingMessageElement.textContent = loadingMessages[messageIndex];
        }

        function startLoadingMessages() {
            messageInterval = setInterval(rotateLoadingMessage, 5000);
        }

        function stopLoadingMessages() {
            clearInterval(messageInterval);
        }

        // Function to save form data to localStorage
        function saveFormData() {
            localStorage.setItem('birthMonth', document.getElementById('birth-month').value);
            localStorage.setItem('birthYear', document.getElementById('birth-year').value);
            localStorage.setItem('country', document.getElementById('country').value);
        }

        // Function to load form data from localStorage
        function loadFormData() {
            const birthMonth = localStorage.getItem('birthMonth');
            const birthYear = localStorage.getItem('birthYear');
            const country = localStorage.getItem('country');

            if (birthMonth) document.getElementById('birth-month').value = birthMonth;
            if (birthYear) document.getElementById('birth-year').value = birthYear;
            if (country) document.getElementById('country').value = country;
        }

        // Load saved data and playlist when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadFormData();
            const savedPlaylist = loadGeneratedPlaylist();
            if (savedPlaylist) {
                generatedPlaylist = savedPlaylist;
                displayPlaylist(generatedPlaylist);
            }
        });

        // Function to save the generated playlist
        function saveGeneratedPlaylist(playlist) {
            localStorage.setItem('generatedPlaylist', JSON.stringify(playlist));
        }

        // Function to load the generated playlist
        function loadGeneratedPlaylist() {
            const savedPlaylist = localStorage.getItem('generatedPlaylist');
            return savedPlaylist ? JSON.parse(savedPlaylist) : null;
        }

        // Function to display the playlist
        function displayPlaylist(playlist) {
            const playlistElement = document.getElementById('playlist');
            playlistElement.innerHTML = ''; // Clear previous results
            playlist.forEach(song => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>${song.year}</strong> - "${song.title}" by ${song.artist}
                    <br>
                    <span class="text-sm text-gray-600">${song.significance}</span>
                `;
                playlistElement.appendChild(li);
            });
            document.getElementById('result').classList.remove('hidden');
            showButtons();
        }

        // Function to handle playlist generation
        async function generatePlaylist(birthMonth, birthYear, country) {
            const errorElement = document.getElementById('error');

            errorElement.classList.add('hidden');
            showLoading();
            startLoadingMessages();

            try {
                controller = new AbortController();
                const signal = controller.signal;

                const response = await fetch('/generate_playlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ birthMonth, birthYear, country }),
                    signal: signal
                });

                const data = await response.json();

                if (response.ok && data.playlist) {
                    generatedPlaylist = data.playlist;
                    saveGeneratedPlaylist(generatedPlaylist);
                    displayPlaylist(generatedPlaylist);
                } else {
                    throw new Error(data.error || 'Failed to generate playlist');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Fetch aborted');
                } else {
                    errorElement.textContent = `Error: ${error.message}`;
                    errorElement.classList.remove('hidden');
                }
            } finally {
                hideLoading();
                stopLoadingMessages();
                controller = null;
            }
        }

        document.getElementById('regenerate-playlist').addEventListener('click', async () => {
            if (!isGenerating) {
                const birthMonth = document.getElementById('birth-month').value;
                const birthYear = document.getElementById('birth-year').value;
                const country = document.getElementById('country').value;
                await generatePlaylist(birthMonth, birthYear, country);
            }
        });

        // Add event listener for the start over button
        document.getElementById('start-over').addEventListener('click', () => {
            localStorage.removeItem('birthMonth');
            localStorage.removeItem('birthYear');
            localStorage.removeItem('country');
            localStorage.removeItem('generatedPlaylist');
            document.getElementById('birth-month').value = '';
            document.getElementById('birth-year').value = '';
            document.getElementById('country').value = '';
            document.getElementById('result').classList.add('hidden');
            document.getElementById('playlist').innerHTML = '';
            document.getElementById('error').classList.add('hidden');
        });

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('submit-btn').disabled = true;
            hideButtons();
            document.getElementById('cancel-generation').classList.remove('hidden');
            isGenerating = true;
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('submit-btn').disabled = false;
            showButtons();
            document.getElementById('cancel-generation').classList.add('hidden');
            isGenerating = false;
        }

        // Add event listener for the cancel button
        document.getElementById('cancel-generation').addEventListener('click', () => {
            if (controller) {
                controller.abort();
                hideLoading();
                stopLoadingMessages();
            }
        });

        function updateSubmitButtonState(disabled) {
            const submitButton = document.getElementById('submit-btn');
            submitButton.disabled = disabled;
            if (disabled) {
                submitButton.textContent = 'Generating...';
            } else {
                submitButton.textContent = 'Generate My Playlist';
            }
        }

        function showButtons() {
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('hidden'));
        }

        function hideButtons() {
            document.querySelectorAll('.btn').forEach(btn => btn.classList.add('hidden'));
        }
    </script>
</body>
</html>